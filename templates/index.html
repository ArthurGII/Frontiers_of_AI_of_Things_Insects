<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InsectDetect Pro - AI-Powered Insect Detection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .upload-section {
            padding: 2rem;
            background: white;
            border-radius: 15px;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .file-upload-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload {
            display: none;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 200px;
            border: 3px dashed var(--secondary-color);
            border-radius: 15px;
            background: rgba(52, 152, 219, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }

        .file-upload-label i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .btn-detect {
            background: linear-gradient(45deg, var(--success-color), #2ecc71);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-detect:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.4);
        }

        .results-section {
            margin: 2rem;
        }

        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.harmful {
            border-left: 5px solid var(--danger-color);
        }

        .stat-card.safe {
            border-left: 5px solid var(--success-color);
        }

        .stat-card.caution {
            border-left: 5px solid var(--warning-color);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .detection-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .prediction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            background: var(--light-bg);
        }

        .prediction-item.harmful {
            border-left: 4px solid var(--danger-color);
            background: rgba(231, 76, 60, 0.05);
        }

        .prediction-item.safe {
            border-left: 4px solid var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }

        .prediction-item.caution {
            border-left: 4px solid var(--warning-color);
            background: rgba(243, 156, 18, 0.05);
        }

        .category-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-harmful {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .badge-safe {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .badge-caution {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .image-container {
            text-align: center;
            margin: 2rem 0;
        }

        .result-image {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        #lightboxOverlay {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        #lightboxOverlay.active {
            display: flex;
        }
        #lightboxOverlay img {
            width: 75vw;
            max-height: 75vh;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            background: white;
            object-fit: contain;
        }
        #lightboxOverlay .close-btn {
            position: absolute;
            top: 30px;
            right: 50px;
            font-size: 2.5rem;
            color: #fff;
            cursor: pointer;
            z-index: 10001;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section, .analytics-card, .detection-card {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1>InsectDetect Pro</h1>
                <p>AI-Powered Insect Detection & Safety Classification</p>
            </div>
            <div class="upload-section">
                <h3>Backlog Images (waiting for analysis)</h3>
                <div id="backlog-images"></div>
            </div>
            <div class="results-section">
                <h3>Analyzed Results</h3>
                <div class="row" id="results-images"></div>
            </div>
            <div class="analytics-card">
                <h3><i class="fas fa-chart-bar"></i> Weekly Detection Trends</h3>
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>
            <div class="d-flex justify-content-end align-items-center" style="margin: 1rem;">
                <form id="deleteAllForm" method="POST" action="/delete_all">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete All Images
                    </button>
                </form>
                <button id="esp32ToggleBtn" class="btn btn-warning ms-2">
                    <i class="fas fa-pause"></i> Stop ESP32 Camera
                </button>
            </div>
        </div>
    </div>

    <div id="lightboxOverlay" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); align-items:center; justify-content:center;">
        <span class="close-btn" style="position:absolute;top:30px;right:50px;font-size:2.5rem;color:#fff;cursor:pointer;z-index:10001;">&times;</span>
        <img src="" alt="Zoomed Image" style="width:75vw;max-height:75vh;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.5);background:white;object-fit:contain;">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
let chartData = {{ analytics_data|tojson|safe }};
let analyticsChart;

function initChart() {
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    analyticsChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { position: 'bottom' },
                datalabels: {
                    display: true,
                    color: '#222',
                    font: { weight: 'bold', size: 12 },
                    anchor: 'center',
                    align: 'center',
                    formatter: function(value, context) {
                        return value > 0 ? context.dataset.label : '';
                    }
                },
                title: {
                    display: true,
                    text: 'Detected Insects by Day (Last 7 Days)'
                }
            },
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            }
        },
        plugins: [ChartDataLabels]
    });
}

function fetchUpdates() {
    fetch('/live_updates')
        .then(response => response.json())
        .then(data => {
            // Backlog images
            const backlogDiv = document.getElementById('backlog-images');
            backlogDiv.innerHTML = '';
            data.backlog_images.forEach(img => {
                backlogDiv.innerHTML += `<img src="/static/backlog/${img}?t=${Date.now()}" class="result-image img-fluid rounded" style="max-width:200px;">`;
            });

            // Results images & predictions
            const resultsRow = document.getElementById('results-images');
            resultsRow.innerHTML = '';
            data.result_images.forEach((img, idx) => {
                let predsHtml = '';
                if (data.predictions[img]) {
                    data.predictions[img].forEach(pred => {
                        predsHtml += `
                            <div class="prediction-item ${pred.category}">
                                <strong>${pred.name}</strong>
                                <span class="category-badge badge-${pred.category}">${pred.category}</span>
                                <small class="text-muted ms-2">Confidence: ${(pred.confidence * 100).toFixed(1)}%</small>
                            </div>
                        `;
                    });
                }
                resultsRow.innerHTML += `
                    <div class="col-6 col-md-3 mb-3">
                        <img src="/static/results/${img}?t=${Date.now()}" class="result-image img-fluid rounded" style="cursor:zoom-in;" data-img="${img}">
                        <button class="btn btn-sm btn-outline-secondary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#predictionsFor${idx}">
                            Show/Hide Results
                        </button>
                        <div class="collapse mt-2" id="predictionsFor${idx}">
                            ${predsHtml}
                        </div>
                    </div>
                `;
            });

            // Update chart
            if (data.analytics_data) {
                analyticsChart.data.labels = data.analytics_data.labels;
                analyticsChart.data.datasets = data.analytics_data.datasets;
                analyticsChart.update('none');
            }
            attachZoomHandlers();
        });
}

window.addEventListener('DOMContentLoaded', () => {
    initChart();
    attachZoomHandlers();
    fetchUpdates();

    // WebSocket pour mise à jour temps réel
    const socket = io();
    socket.on('new_image', () => {
        fetchUpdates();
    });
});

function attachZoomHandlers() {
    const lightboxOverlay = document.getElementById('lightboxOverlay');
    const lightboxImg = lightboxOverlay.querySelector('img');
    const closeBtn = lightboxOverlay.querySelector('.close-btn');
    document.querySelectorAll('.result-image').forEach(img => {
        img.onclick = function() {
            lightboxImg.src = this.src;
            lightboxOverlay.style.display = 'flex';
        };
    });
    closeBtn.onclick = () => { lightboxOverlay.style.display = 'none'; };
    lightboxOverlay.onclick = (e) => { if (e.target === lightboxOverlay) lightboxOverlay.style.display = 'none'; };
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') lightboxOverlay.style.display = 'none';
    });
}

// ESP32 toggle button
let esp32Active = true;

function setEsp32Button(active) {
    const btn = document.getElementById('esp32ToggleBtn');
    if (active) {
        btn.innerHTML = '<i class="fas fa-pause"></i> Stop ESP32 Camera';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
    } else {
        btn.innerHTML = '<i class="fas fa-play"></i> Resume ESP32 Camera';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
    }
}

document.getElementById('esp32ToggleBtn').onclick = function() {
    if (esp32Active) {
        fetch('/stop_esp32', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert('ESP32 stop command sent!\n' + (data.esp32_response || data.status));
                esp32Active = false;
                setEsp32Button(false);
            })
            .catch(err => {
                alert('Error sending stop command to ESP32.');
            });
    } else {
        fetch('/resume_esp32', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert('ESP32 resume command sent!\n' + (data.esp32_response || data.status));
                esp32Active = true;
                setEsp32Button(true);
            })
            .catch(err => {
                alert('Error sending resume command to ESP32.');
            });
    }
};

window.addEventListener('DOMContentLoaded', () => {
    setEsp32Button(true);
});

// Delete all images button (refresh UI immediately)
document.getElementById('deleteAllForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (confirm('Delete ALL images? This cannot be undone!')) {
        fetch('/delete_all', { method: 'POST' })
            .then(() => {
                fetchUpdates();
            });
    }
});
    </script>
</body>
</html>